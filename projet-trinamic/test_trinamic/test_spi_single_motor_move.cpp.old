#include "tmc4671_tests.h"
#include <mbed.h>

void set_speed(int32_t speed)
{
  tmc4671_writeRegister(0, TMC4671_UQ_UD_EXT, 0x09130000);

  tmc4671_writeRegister(0, TMC4671_OPENLOOP_VELOCITY_TARGET, speed);

  wait_us(500000);

  tmc4671_writeRegister(0, TMC4671_OPENLOOP_VELOCITY_TARGET, 0);

  tmc4671_writeRegister(0, TMC4671_UQ_UD_EXT, 0x00000000);
}

void test_spi_single_motor_move()
{

  tmc4671_initSPI();

// use TMC4671 API
#include "TMC4671.h"

  // Motor type &  PWM configuration
  tmc4671_writeRegister(0, TMC4671_MOTOR_TYPE_N_POLE_PAIRS, 0x00030008);
  tmc4671_writeRegister(0, TMC4671_PWM_POLARITIES, 0x00000000);
  tmc4671_writeRegister(0, TMC4671_PWM_MAXCNT, 0x00000F9F);
  tmc4671_writeRegister(0, TMC4671_PWM_BBM_H_BBM_L, 0x00001919);
  tmc4671_writeRegister(0, TMC4671_PWM_SV_CHOP, 0x00000007);

  // ADC configuration
  tmc4671_writeRegister(0, TMC4671_ADC_I_SELECT, 0x24000100);
  tmc4671_writeRegister(0, TMC4671_DSADC_MCFG_B_MCFG_A, 0x00100010);
  tmc4671_writeRegister(0, TMC4671_DSADC_MCLK_A, 0x20000000);
  tmc4671_writeRegister(0, TMC4671_DSADC_MCLK_B, 0x20000000);
  tmc4671_writeRegister(0, TMC4671_DSADC_MDEC_B_MDEC_A, 0x014E014E);
  tmc4671_writeRegister(0, TMC4671_ADC_I0_SCALE_OFFSET, 0x00328394);
  tmc4671_writeRegister(0, TMC4671_ADC_I1_SCALE_OFFSET, 0x003283FE);

  // Open loop settings
  tmc4671_writeRegister(0, TMC4671_OPENLOOP_MODE, 0x00000000);
  tmc4671_writeRegister(0, TMC4671_OPENLOOP_ACCELERATION, 0x0000003C);
  tmc4671_writeRegister(0, TMC4671_OPENLOOP_VELOCITY_TARGET, 0x0000000A);

  // Feedback selection
  tmc4671_writeRegister(0, TMC4671_PHI_E_SELECTION, 0x00000002);
  tmc4671_writeRegister(0, TMC4671_UQ_UD_EXT, 0x09130000);

  // ===== Open loop test drive =====
  DigitalOut led(LED1);
  led = 1;
  // Switch to open loop velocity mode
  tmc4671_writeRegister(0, TMC4671_MODE_RAMP_MODE_MOTION, 0x00000008);

  // Rotate right
  tmc4671_writeRegister(0, TMC4671_OPENLOOP_VELOCITY_TARGET, 0x0000003C);
  wait_us(2000000);

  // Rotate left
  tmc4671_writeRegister(0, TMC4671_OPENLOOP_VELOCITY_TARGET, 0xFFFFFFC4);
  wait_us(4000000);

  // Stop
  tmc4671_writeRegister(0, TMC4671_OPENLOOP_VELOCITY_TARGET, 0x00000000);
  wait_us(2000000);
  tmc4671_writeRegister(0, TMC4671_UQ_UD_EXT, 0x00000000);

  set_speed(100);
}

